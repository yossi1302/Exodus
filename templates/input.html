{% extends "base.html" %}

{% block title %}Upload Requirements - FSP Schedule Generator{% endblock %}

{% block content %}
<div class="upload-section">
    <h2>Upload Schedule Requirements</h2>
    <p>Upload a JSON file containing course information, teacher availability, and program details.</p>
    
    <div class="upload-form">
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="form-group">
                <label for="fileInput">Select JSON File</label>
                <input type="file" id="fileInput" name="file" accept=".json" required>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Generate Schedule</button>
                <a href="{{ url_for('download_example') }}" class="btn btn-secondary">Download Example</a>
            </div>
        </form>
        
        <div id="statusMessage" class="status-message"></div>
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Generating schedule... This may take a few minutes.</p>
        </div>
    </div>
    
    <div class="preview-section" id="previewSection" style="display: none;">
        <h3>Input Preview</h3>
        <pre id="jsonPreview"></pre>
    </div>
</div>

<div class="instructions">
    <h3>JSON Structure</h3>
    <p>Your JSON file should contain the following structure:</p>
    
    <pre>{
  "metadata": {
    "period": "Period 2",
    "year": "2024-2025",
    "weeks": 7
  },
  "courses": [
    {
      "code": "BCS1220",
      "name": "Course Name",
      "lectures": 1,
      "tutorials": 1,
      "labs": 2,
      "hours_per_session": 2,
      "theory_before_practical": true
    }
  ],
  "teachers": {
    "Teacher Name": {
      "courses": ["BCS1220"],
      "unavailable": ["Monday-08:30"]
    }
  },
  "programs": {
    "CS_Y1": {
      "size": 300,
      "courses": ["BCS1220", "BCS1440"]
    }
  }
}</pre>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('uploadForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const fileInput = document.getElementById('fileInput');
    const statusMessage = document.getElementById('statusMessage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    if (!fileInput.files.length) {
        statusMessage.className = 'status-message error';
        statusMessage.textContent = 'Please select a file';
        return;
    }
    
    // Show loading
    loadingIndicator.style.display = 'block';
    statusMessage.textContent = '';
    
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    
    try {
        const response = await fetch('/input', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        loadingIndicator.style.display = 'none';
        
        if (response.ok && result.success) {
            statusMessage.className = 'status-message success';
            statusMessage.textContent = result.message;
            
            // Redirect to schedule view after 1 second
            setTimeout(() => {
                window.location.href = `/schedule/${result.schedule_id}`;
            }, 1000);
        } else {
            statusMessage.className = 'status-message error';
            statusMessage.textContent = 'Error: ' + result.error;
        }
    } catch (error) {
        loadingIndicator.style.display = 'none';
        statusMessage.className = 'status-message error';
        statusMessage.textContent = 'Error: ' + error.message;
    }
});

// File preview
document.getElementById('fileInput').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const json = JSON.parse(event.target.result);
                document.getElementById('jsonPreview').textContent = JSON.stringify(json, null, 2);
                document.getElementById('previewSection').style.display = 'block';
            } catch (error) {
                document.getElementById('previewSection').style.display = 'none';
            }
        };
        reader.readAsText(file);
    }
});
</script>
{% endblock %}
